
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>7. Slurm Overview &#8212; Crunchomics 0.01 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="8. Slurm Jobs" href="slurm_jobs.html" />
    <link rel="prev" title="6. Miniconda" href="miniconda.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="slurm_jobs.html" title="8. Slurm Jobs"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="miniconda.html" title="6. Miniconda"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Crunchomics 0.01 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7. </span>Slurm Overview</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="slurm-overview">
<h1><span class="section-number">7. </span>Slurm Overview<a class="headerlink" href="#slurm-overview" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p>Jobs on the compute cluster are scheduled by a queue manager or cluster workload manager, called Slurm.</p></li>
<li><dl class="simple">
<dt>Slurm has three key functions.</dt><dd><ol class="arabic simple">
<li><p>It allocates exclusive and/or non-exclusive access to resources (compute nodes) to users for some duration of time.</p></li>
<li><p>It provides a framework for starting, executing, and monitoring work (normally a parallel job) on the set of allocated nodes.</p></li>
<li><p>It arbitrates contention for resources by managing a queue of pending work.</p></li>
</ol>
</dd>
</dl>
</li>
<li><p>Although Slurm offers several ways to restrict the use of resources to a maximum, currently Crunchomics is set up to give users a maximum amount of freedom. It is very easy to claim significant parts or even the whole cluster for extended periods of time. We expect users to use this freedom wisely and allow other users to do their work. Keep an eye on the overall system usage while running big jobs. Also free allocations which are not used. If you plan to run very big projects (10.000+ core-hours) you are encouraged to contact us beforehand to discuss distribution of the work in time. If we notice a user is using too much resources we will contact him or her. If necessary we can put restrictions on usage.</p></li>
</ul>
<div class="section" id="additional-help-and-information">
<h2><span class="section-number">7.1. </span>Additional help and information<a class="headerlink" href="#additional-help-and-information" title="Permalink to this headline">¶</a></h2>
<p>This guide only covers a basic introduction/overview of Slurm with a focus on subjects which are specific to the Crunchomics cluster and bioinformatics problems and  targeted at people who have some familiarity with the command line. Lots of information about slurm and the commands to use slurm is availabe from other sources:</p>
<ul class="simple">
<li><p>Detailed help information with the slurm commands is available, e.g. <code class="docutils literal notranslate"><span class="pre">sinfo</span> <span class="pre">--help</span></code></p></li>
<li><p>Nice tutorials and intros on the web, e.g. <a class="reference external" href="https://slurm.schedmd.com/quickstart.html">Slurm quick start</a>.</p></li>
</ul>
</div>
<div class="section" id="quick-slurm-demo">
<h2><span class="section-number">7.2. </span>Quick slurm demo<a class="headerlink" href="#quick-slurm-demo" title="Permalink to this headline">¶</a></h2>
<div class="section" id="information-about-the-cluster">
<h3><span class="section-number">7.2.1. </span>Information about the cluster<a class="headerlink" href="#information-about-the-cluster" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">sinfo</span></code> to get information about the cluster: node names, state, partition (queue)</dt><dd><ul>
<li><p>partition: the queues that are available</p></li>
<li><p>state: idle (available for jobs), mix (partly available), down etc. <a class="reference external" href="https://baobabmaster.unige.ch/slurmdoc/sinfo.html#lbAG/">Slurm codes</a></p></li>
<li><p>node list: the names of the nodes omics-cn001 to omics-cn005</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/slurm1.png"><img alt="_images/slurm1.png" src="_images/slurm1.png" style="width: 500px; height: 65px;" /></a>
</div>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">squeue</span></code>: view information about jobs in the queue</dt><dd><ul>
<li><p>JOBID: every job gets a number. You can manipulate jobs via this number (e.g. with <code class="docutils literal notranslate"><span class="pre">scancel</span></code>)</p></li>
<li><p>ST: state, R = running, PD = pending, see: <a class="reference external" href="https://slurm.schedmd.com/squeue.html#lbAG/">Slurm state codes</a>.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="_images/slurm2.png"><img alt="_images/slurm2.png" src="_images/slurm2.png" style="width: 500px; height: 180px;" /></a>
</div>
</div>
<div class="section" id="multithreading">
<h3><span class="section-number">7.2.2. </span>Multithreading<a class="headerlink" href="#multithreading" title="Permalink to this headline">¶</a></h3>
<p>Example of running a multithreaded program, which will be used to illustrate the use of slurm further below. We want to map a collection of reads (<strong>READS</strong>)  to an an organism (<strong>DB</strong>) and write the result to <strong>RESFILE</strong>.  (<code class="docutils literal notranslate"><span class="pre">/dev/null</span></code> means the data is discarded)</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#You could run this program interactively on omics-h0.science.uva.nl</span>
<span class="nb">export</span> <span class="nv">READS</span><span class="o">=</span><span class="s2">&quot;/zfs/omics/software/doc/Crunchomics_intro/DemoData/sample_1M.fastq&quot;</span>
<span class="nb">export</span> <span class="nv">DB</span><span class="o">=</span><span class="s2">&quot;/zfs/omics/software/doc/Crunchomics_intro/DemoData/db/NC_000913_ncbi&quot;</span>
<span class="nb">export</span> <span class="nv">RESFILE</span><span class="o">=</span><span class="s2">&quot;/dev/null&quot;</span>
<span class="c1">#</span>
<span class="c1"># single thread:</span>
bowtie2 -t  -p <span class="m">1</span>  -x  <span class="nv">$DB</span> -U <span class="nv">$READS</span> &gt;  <span class="nv">$RESFILE</span>
<span class="c1"># multi threaded  use 4 threads:</span>
bowtie2 -t  -p <span class="m">4</span>  -x  <span class="nv">$DB</span> -U <span class="nv">$READS</span> &gt;  <span class="nv">$RESFILE</span>
</pre></div>
</div>
</div>
<div class="section" id="srun">
<h3><span class="section-number">7.2.3. </span>srun<a class="headerlink" href="#srun" title="Permalink to this headline">¶</a></h3>
<p>However, it is more efficient to run this mapping on the compute cluster using the same command in slurm with <code class="docutils literal notranslate"><span class="pre">srun</span></code> executed from the head node omics-h0.science.uva.nl:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># run bowtie as a single job with 16 cores:</span>
srun -n <span class="m">1</span> --cpus-per-task <span class="m">16</span>  bowtie2 -t -p <span class="m">16</span>  -x  <span class="nv">$DB</span> -U <span class="nv">$READS</span>  &gt;  <span class="nv">$RESFILE</span>
<span class="c1"># also possible: run an interactive  shell on a compute node, in this case for 10 minutes:</span>
srun --pty -t <span class="m">10</span> bash -i
</pre></div>
</div>
<ul class="simple">
<li><p>Allocation of the compute resource is for the duration of the command.</p></li>
</ul>
</div>
<div class="section" id="salloc">
<h3><span class="section-number">7.2.4. </span>salloc<a class="headerlink" href="#salloc" title="Permalink to this headline">¶</a></h3>
<p>Often a job consists of a number of steps (jobsteps)</p>
<ul class="simple">
<li><p>Explicit allocation with <code class="docutils literal notranslate"><span class="pre">salloc</span></code> for interactive running of several jobs in row.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># allocate 16 cpu&#39;s on a single node, in this case for 30 minutes</span>
salloc -n <span class="m">1</span> -t <span class="m">30</span> --cpus-per-task <span class="m">16</span> bash
<span class="c1"># the shell runs on the headnode srun is used to use the allocation</span>
<span class="c1"># srun uses the available cpu&#39;s in the allocation and using</span>
srun bowtie2 -t  -p <span class="m">16</span>  -x  <span class="nv">$DB</span> -U <span class="nv">$READS</span>  &gt;  <span class="nv">$RESFILE</span>
<span class="c1"># with salloc we set 16 cpus-per-task.</span>
<span class="c1"># Slurm holds this information in the variable $SLURM_CPUS_PER_TASK,</span>
<span class="c1"># which we can use in the bowtie command:</span>
srun bowtie2 -t  -p <span class="nv">$SLURM_CPUS_PER_TASK</span>  -x  <span class="nv">$DB</span> -U <span class="nv">$READS</span>  &gt;  <span class="nv">$RESFILE</span>
<span class="c1">#</span>
<span class="c1"># more SLURM variables in the environment:</span>
env <span class="p">|</span> grep SLURM
<span class="c1">#</span>
<span class="c1"># it is not a good idea to ask for more threads than available in the allocation</span>
srun bowtie2 -t  -p <span class="m">64</span>  -x  <span class="nv">$DB</span> -U <span class="nv">$READS</span>  &gt;  <span class="nv">$RESFILE</span>
<span class="c1"># the threads start to compete for the 16 availabe cores.</span>
<span class="c1"># If we ask for less threads than available</span>
srun bowtie2 -t  -p <span class="m">2</span>  -x  <span class="nv">$DB</span> -U <span class="nv">$READS</span>  &gt;  <span class="nv">$RESFILE</span>
<span class="c1"># only 2 cores in the allocation  are used</span>
<span class="nb">exit</span>
<span class="c1">#  Release the allocated resources</span>
</pre></div>
</div>
</div>
<div class="section" id="sbatch">
<h3><span class="section-number">7.2.5. </span>sbatch<a class="headerlink" href="#sbatch" title="Permalink to this headline">¶</a></h3>
<p>srun and salloc wait/block until resources are available. If the cluster is full you have to wait until resources become available. Sbatch is used to send the job to put the job in the queue and schedule it when the resources become available.</p>
<p>sbatch: create batch file called <code class="docutils literal notranslate"><span class="pre">test.sc</span></code> in a text editor on the headnode (e.g. vim, nano, gedit). It has the following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash
#SBATCH --cpus-per-task 16
srun bowtie2 -t  -p $SLURM_CPUS_PER_TASK  -x  $DB -U $READS  &gt;  $RESFILE
</pre></div>
</div>
<ul class="simple">
<li><p><em>Note: the #SBATCH is not a comment but sets the cpus per task variable to 16. See below.</em></p></li>
</ul>
<p>Submit the created batch file to slurm using sbatch:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sbatch test.sc
</pre></div>
</div>
<p>In batch mode the standard output of the issued commands, which would normally appear in the terminal is written to a file. By default the name of this file is <code class="docutils literal notranslate"><span class="pre">slurm-&lt;JOBID&gt;.out</span></code>  After a job is submitted it will run independent of the terminal, you can log out and come back later for the results.</p>
<p>The compute resources that are asked for and other job parameters can be specified by <em>parameters</em>. These parameters can be specified on the commandline (like in the salloc example above). For sbatch the parameters can be included in the batch script. The previously given <code class="docutils literal notranslate"><span class="pre">#SBATCH</span> <span class="pre">--cpus-per-task</span> <span class="pre">16</span></code> is an example in which 16 cpus are asked for. Lines starting with <code class="docutils literal notranslate"><span class="pre">#SBATCH</span></code> are interpreted as parameters for the slurm job. Possible parameters can be found in the Slurm documentation: <a class="reference external" href="https://slurm.schedmd.com/sbatch.html">Sbatch</a></p>
</div>
<div class="section" id="scancel">
<h3><span class="section-number">7.2.6. </span>scancel<a class="headerlink" href="#scancel" title="Permalink to this headline">¶</a></h3>
<p>Use scancel to kill running jobs and remove waiting jobs from the queue</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scancel <span class="o">[</span>JOBID<span class="o">]</span>
</pre></div>
</div>
<p>is used to cancel a particular job. All your jobs are killed/removed using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scancel -u <span class="nv">$USER</span>
</pre></div>
</div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">7. Slurm Overview</a><ul>
<li><a class="reference internal" href="#additional-help-and-information">7.1. Additional help and information</a></li>
<li><a class="reference internal" href="#quick-slurm-demo">7.2. Quick slurm demo</a><ul>
<li><a class="reference internal" href="#information-about-the-cluster">7.2.1. Information about the cluster</a></li>
<li><a class="reference internal" href="#multithreading">7.2.2. Multithreading</a></li>
<li><a class="reference internal" href="#srun">7.2.3. srun</a></li>
<li><a class="reference internal" href="#salloc">7.2.4. salloc</a></li>
<li><a class="reference internal" href="#sbatch">7.2.5. sbatch</a></li>
<li><a class="reference internal" href="#scancel">7.2.6. scancel</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="miniconda.html"
                        title="previous chapter"><span class="section-number">6. </span>Miniconda</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="slurm_jobs.html"
                        title="next chapter"><span class="section-number">8. </span>Slurm Jobs</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/slurm_overview.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="slurm_jobs.html" title="8. Slurm Jobs"
             >next</a> |</li>
        <li class="right" >
          <a href="miniconda.html" title="6. Miniconda"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Crunchomics 0.01 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href=""><span class="section-number">7. </span>Slurm Overview</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Han Rauwerda Wim de Leeuw SILS-MAD-RB&amp;AB.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>